#include <unistd.h>
#include <rtems/bspIo.h>
#include <rtems/sysinit.h>

#include <bsp.h>
#include <bsp/fdt.h>
#include <bsp/bootcard.h>
#include <bsp/irq-generic.h>
#include <bsp/linker-symbols.h>
#include <bsp/arm-cp15-start.h>
#include <bsp/arm-a9mpcore-start.h>

#include "bsp/io.h"
#include "component/compiler.h"

#define PRM_DEVICE 0x44DF4000

#define PRCM_PRM_RSTCTRL  0
#define RST_GLOBAL_COLD_SW 0x2
#define RST_GLOBAL_WARM_SW 0x1


/*
 * User mmu configure infomation
 */
BSP_START_DATA_SECTION static const
arm_cp15_start_section_config _am43xx_mmu_configs[] = {
  ARMV7_CP15_START_DEFAULT_SECTIONS,
  {
    .begin = 0x40000000U,
    .end = 0x4FFFFFFF,
    .flags = ARMV7_MMU_DEVICE
  }
};

/*
 * Overwrite bsp default mmu configuration
 */
BSP_START_TEXT_SECTION void __notrace setup_mmu_and_cache(void) {
    uint32_t ctrl = arm_cp15_start_setup_mmu_and_cache(
      ARM_CP15_CTRL_A | ARM_CP15_CTRL_I | ARM_CP15_CTRL_C | ARM_CP15_CTRL_M,
      ARM_CP15_CTRL_AFE | ARM_CP15_CTRL_Z
    );

    arm_cp15_start_setup_translation_table(
      (uint32_t *) bsp_translation_table_base,
      ARM_MMU_DEFAULT_CLIENT_DOMAIN,
      &_am43xx_mmu_configs[0],
      RTEMS_ARRAY_SIZE(_am43xx_mmu_configs)
    );

    /* Enable MMU and cache */
    ctrl |= ARM_CP15_CTRL_I | ARM_CP15_CTRL_C | ARM_CP15_CTRL_M;
    arm_cp15_set_control(ctrl);
}

BSP_START_TEXT_SECTION __notrace void bsp_start_hook_0(void) {
    arm_a9mpcore_start_hook_0();
}

BSP_START_TEXT_SECTION __notrace void bsp_start_hook_1(void) { 
    arm_a9mpcore_start_hook_1();
    bsp_start_copy_sections();
    setup_mmu_and_cache();
    rtems_cache_enable_data();
    bsp_start_clear_bss();
}

void __notrace bsp_start(void) {
    bsp_interrupt_initialize();
    rtems_cache_coherent_add_area(bsp_section_nocacheheap_begin,
        (uintptr_t)bsp_section_nocacheheap_size);
}

uint32_t __notrace bsp_fdt_map_intr(const uint32_t *intr, 
	size_t icells) {
    return intr[1] + 32;
}

void __notrace bsp_reset(void) {
    uint32_t level;
    printk("System reseting...\n");
    // sync();
    rtems_interrupt_disable(level);
    writel(RST_GLOBAL_WARM_SW, PRM_DEVICE);
}

/* LIBBSD PHY DRIVER */
#if defined(__rtems_libbsd__)
#include <rtems/bsd/bsd.h>
SYSINIT_DRIVER_REFERENCE(micphy, miibus);
//SYSINIT_DRIVER_REFERENCE(ukphy, miibus);
#endif